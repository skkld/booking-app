<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application Settings</title>
    
    <script type="module" src="/auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link rel="stylesheet" href="/styles.css">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <nav class="sidebar">
        <div class="sidebar-header">
            <img src="/assets/logo.png" alt="Booking App Logo" class="logo-img">
            <span>Booking App</span>
        </div>
        <ul class="sidebar-nav">
            <li class="nav-item"><a href="/" class="nav-link">Dashboard</a></li>
            <li class="nav-item"><a href="/projects.html" class="nav-link">Projects</a></li>
            <li class="nav-item"><a href="/scheduling.html" class="nav-link">Scheduling</a></li>
            <li class="nav-item"><a href="/employees.html" class="nav-link">Employees</a></li>
            <li class="nav-item"><a href="/timecards.html" class="nav-link">Timecards</a></li>
            <li class="nav-item"><a href="/settings.html" class="nav-link active">Settings</a></li>
            <li class="nav-item"><a href="#" id="logout-btn" class="nav-link">Log Out</a></li>
        </ul>
    </nav>

    <main class="main-content">
        <header class="header"><h1>Application Settings</h1></header>

        <div class="tab-container">
            <div class="tab-nav">
                <button class="tab-link active" data-tab="my-account-tab">My Account</button>
                
                <button class="tab-link" data-tab="positions-tab" style="display: none;">Positions & Rates</button>
                <button class="tab-link" data-tab="payroll-rules-tab" style="display: none;">Payroll Rules</button>
                <button class="tab-link" data-tab="union-rules-tab" style="display: none;">Union Rules</button>
                <button class="tab-link" data-tab="templates-tab" style="display: none;">Email Templates</button>
                
                <button class="tab-link" data-tab="users-tab" style="display: none;">User Management</button>
            </div>

            <div id="my-account-tab" class="tab-content active">
                <div class="card">
                    <div class="card-header"><h3>Change My Password</h3></div>
                    <form id="my-password-form" class="card-body form-grid">
                        <div class="form-group"><label>New Password</label><input type="password" id="my-new-password" required></div>
                        <div class="form-actions"><button type="submit" class="btn btn-primary">Update Password</button></div>
                    </form>
                </div>
            </div>

            <div id="positions-tab" class="tab-content" style="display: none;">
                <div class="card">
                    <div class="card-header"><h3>Manage Positions</h3></div>
                    <div class="card-body">
                        <div class="page-grid">
                            <form id="add-position-form" class="form-grid">
                                <h4>Add New Position</h4>
                                <div class="form-group"><label for="position_name">Position Name</label><input type="text" id="position_name" name="name" required></div>
                                <div class="form-group"><label for="default_rate">Default Rate (per hour)</label><input type="number" id="default_rate" name="default_rate" step="0.01" min="0" class="form-control"></div>
                                <div class="form-actions"><button type="submit" class="btn btn-primary">+ Add Position</button></div>
                            </form>
                            <div class="card-span-2">
                                <h4>Existing Positions</h4>
                                <div class="table-container">
                                    <table class="data-table">
                                        <thead><tr><th>Position Name</th><th>Default Rate</th><th>Actions</th></tr></thead>
                                        <tbody id="positions-list-table"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="payroll-rules-tab" class="tab-content" style="display: none;">
                <div class="card">
                    <div class="card-header"><h3>Company Payroll Rules</h3></div>
                    <form id="payroll-rules-form" class="card-body form-grid">
                        <div class="form-group"><label for="week_start_day">Week Starts On</label><select id="week_start_day" name="week_start_day" class="form-control" style="padding: 0.75rem;"><option value="Monday">Monday</option><option value="Sunday">Sunday</option></select></div>
                        <div class="form-group"><label for="daily_overtime_threshold">Overtime After (hours)</label><input type="number" id="daily_overtime_threshold" name="daily_overtime_threshold" step="0.5" min="0" class="form-control"></div>
                        <div class="form-group"><label for="night_premium_start">Night Premium Start Time</label><input type="time" id="night_premium_start" name="night_premium_start" class="form-control"></div>
                        <div class="form-group"><label for="night_premium_end">Night Premium End Time</label><input type="time" id="night_premium_end" name="night_premium_end" class="form-control"></div>
                        <div class="form-group"><label for="auto_break_threshold">Auto-Deduct Break After (hours)</label><input type="number" id="auto_break_threshold" name="auto_break_threshold" step="0.5" min="0" class="form-control"></div>
                        <div class="form-group"><label for="auto_break_duration">Auto-Deduct Break Duration (minutes)</label><input type="number" id="auto_break_duration" name="auto_break_duration" step="15" min="0" class="form-control"></div>
                        <div class="form-actions" style="grid-column: 1 / -1;"><button type="submit" class="btn btn-primary">Save Payroll Rules</button></div>
                    </form>
                </div>
            </div>

            <div id="union-rules-tab" class="tab-content" style="display: none;">
                <div class="card">
                    <div class="card-header"><h3>Union Payroll Rules</h3></div>
                    <div class="card-body">
                        <p style="color: var(--text-light); margin-bottom: 1.5rem;">These rules override Company Rules on "Union Projects".</p>
                        <form id="union-rules-form" class="form-grid">
                            <div class="form-group"><label for="union_daily_overtime_threshold">Overtime After (hours)</label><input type="number" id="union_daily_overtime_threshold" name="daily_overtime_threshold" step="0.5" min="0" class="form-control"></div>
                            <div class="form-group"><label for="union_night_premium_start">Night Premium Start Time</label><input type="time" id="union_night_premium_start" name="night_premium_start" class="form-control"></div>
                            <div class="form-group"><label for="union_night_premium_end">Night Premium End Time</label><input type="time" id="union_night_premium_end" name="night_premium_end" class="form-control"></div>
                            <div class="form-group"><label for="union_auto_break_threshold">Auto-Deduct Break After (hours)</label><input type="number" id="union_auto_break_threshold" name="auto_break_threshold" step="0.5" min="0" class="form-control"></div>
                            <div class="form-group"><label for="union_auto_break_duration">Auto-Deduct Break Duration (minutes)</label><input type="number" id="union_auto_break_duration" name="auto_break_duration" step="15" min="0" class="form-control"></div>
                            <div class="form-group-checkbox" style="grid-column: 1 / -1;"><input type="checkbox" id="union_calculate_sundays_as_ot" name="calculate_sundays_as_ot"><label for="union_calculate_sundays_as_ot">Calculate all Sunday hours as Overtime</label></div>
                            <div class="form-actions" style="grid-column: 1 / -1;"><button type="submit" class="btn btn-primary">Save Union Rules</button></div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div id="templates-tab" class="tab-content" style="display: none;">
                <div class="card">
                    <div class="card-header"><h3>Manage Email Templates</h3></div>
                    <div class="card-body"><div class="table-container"><table class="data-table"><thead><tr><th>Template Name</th><th>Subject</th><th>Active</th><th>Actions</th></tr></thead><tbody id="templates-list-table"></tbody></table></div></div>
                    <div class="card-footer" style="text-align: right;"><button id="add-template-btn" class="btn btn-primary">+ Add New Template</button></div>
                </div>
            </div>

            <div id="users-tab" class="tab-content" style="display: none;">
                <div class="card">
                    <div class="card-header"><h3>Invite New User</h3></div>
                    <form id="invite-user-form" class="card-body form-grid">
                        <p style="color: var(--text-light);">This will create a new login and a new employee profile.</p>
                        <div class="form-group"><label for="user-email">Email</label><input type="email" id="user-email" required></div>
                        <div class="form-group"><label for="user-password">Temporary Password</label><input type="password" id="user-password" required></div>
                        <div class="form-group"><label for="user-role">Role</label><select id="user-role" class="form-control" style="padding: 0.75rem;"><option value="crew">Crew</option><option value="manager">Manager</option><option value="admin">Admin</option></select></div>
                        <div class="form-actions" style="grid-column: 1 / -1;"><button type="submit" class="btn btn-primary">Send Invite / Create User</button></div>
                    </form>
                </div>
                <div class="card">
                    <div class="card-header"><h3>Registered Users</h3></div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead><tr><th>Email</th><th>Role</th><th>Actions</th></tr></thead>
                            <tbody id="users-list-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="template-modal" class="modal-overlay" style="display: none;">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header"><h3 id="template-modal-title">Add New Template</h3><button id="template-modal-close" class="modal-close">&times;</button></div>
                <div class="modal-body">
                    <form id="template-form">
                        <input type="hidden" id="template-id">
                        <div class="form-grid">
                            <div class="form-group"><label for="template-name">Template Name</label><input type="text" id="template-name" required></div>
                            <div class="form-group"><label for="template-subject">Email Subject</label><input type="text" id="template-subject" required></div>
                            <div class="form-group"><label for="template-body">Email Body (HTML)</label><textarea id="template-body" rows="15" required></textarea></div>
                            <div class="form-group-checkbox"><input type="checkbox" id="template-active"><label for="template-active">Set as active template</label></div>
                            <p style="font-size: 0.8rem; color: var(--text-light);">Variables: `{project_name}`, `{employee_name}`, `{shift_name}`, `{shift_role}`, `{shift_date}`, `{shift_time}`, `{location}`, `{contact}`, `{dress_code}`, `{parking}`, `{notes}`, `{yes_link}`, `{no_link}`</p>
                        </div>
                        <div class="form-actions" style="text-align: right; margin-top: 1.5rem;"><button type="submit" class="btn btn-primary">Save Template</button></div>
                    </form>
                </div>
            </div>
        </div>
        <div id="change-password-modal" class="modal-overlay" style="display: none;">
            <div class="modal-content"><div class="modal-header"><h3 id="change-password-title">Change Password</h3><button id="change-password-close" class="modal-close">&times;</button></div><form id="change-password-form" class="modal-body"><input type="hidden" id="change-password-user-id"><div class="form-group"><label for="new-password">New Password</label><input type="password" id="new-password" class="form-control" required></div><div class="form-actions" style="text-align: right;"><button type="submit" class="btn btn-primary">Set New Password</button></div></form></div>
        </div>
        <div id="delete-user-modal" class="modal-overlay" style="display: none;">
            <div class="modal-content"><div class="modal-header"><h3 id="delete-user-title">Confirm Deletion</h3><button id="delete-user-close" class="modal-close">&times;</button></div><form id="delete-user-form" class="modal-body"><input type="hidden" id="delete-user-id"><p>To delete this user, please enter **your** admin password to confirm.</p><div class="form-group"><label for="admin-password-confirm">Your Admin Password</label><input type="password" id="admin-password-confirm" class="form-control" required></div><div class="form-actions" style="text-align: right;"><button type="submit" class="btn btn-danger">Permanently Delete User</button></div></form></div>
        </div>
    </main>
    
    <script type="module" src="/logout.js"></script>
    <script type="module" src="/settings.js"></script>
</body>
</html>